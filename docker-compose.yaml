#
# Metrics services -- provides a web GUI to monitor Lighthouse nodes.
#
services:
    prometheus:
        build:
            context: prometheus
        volumes:
            - prometheus-data:/prometheus
            - type: bind
              source: ./scrape-targets
              target: /prometheus/targets
        restart: always
        network_mode: host
        command:
        - '--web.listen-address=127.0.0.1:9090'
        - '--config.file=/etc/prometheus/prometheus.yml'
        - '--storage.tsdb.path=/prometheus'
        - '--web.enable-remote-write-receiver'
        - '--web.console.libraries=/usr/share/prometheus/console_libraries'
        - '--web.console.templates=/usr/share/prometheus/consoles'

    grafana:
        build:
            context: grafana
        volumes:
            - grafana-data:/var/lib/grafana
            - ./grafana/provisioning:/etc/grafana/provisioning  # auto-add Tempo source
        restart: always
        network_mode: host

    tempo:
        image: grafana/tempo:latest
        command: [ "-config.file=/etc/tempo.yaml" ]
        volumes:
            - ./tempo.yaml:/etc/tempo.yaml
        restart: always
        network_mode: host  # enables gRPC/HTTP OTLP on localhost

volumes:
    grafana-data:
    prometheus-data:
    targets:
